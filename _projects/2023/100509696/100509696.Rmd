---
title: "New dataviz project"
description: |
  A short description of the post.
author: JIEUN PARK
date: 2023-12-11
output:
  distill::distill_article:
    self_contained: false
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(out.width="100%", fig.align="center")
```

## Packages and libraries

```{r}
#install.packages("readxl")
library(readxl)
#install.packages("reshape2")
library(reshape2)
#install.packages("dplyr")
library(dplyr)
library(tidyr)
library(tidyverse)
library(scales)
#install.packages("ggcharts")
library(ggplot2)
library(ggalluvial)
#install.packages("ggsankey")
library(ggsankey)

```

This graph explains how the electricity generation sources have been changed in the United States from 2001 to 2017 over 16 years. The data covers all 50 states from the United States. Sources are arranged in order of percentages and it has crossover features in the graph. 

Usually, over 16 years, coal, nuclear, and natural gas are the main resources of electric generation in the U.S. According to the article, the ranking of different sources have not been changed very much almost over 17 years for 13 states. In this other 37 states, both the percentages of electricity generated and the relative ordering for different sources have changed noticeably. Therefore, the crossovers of different sources for the electiricty generation in the graph are affected mostly by these 37 states. 

## Original graph
```{r}
knitr::include_graphics("~/Desktop/data visualization/ElectricitySourcesLN-superJumbo.webp")
```

## Data and Data Processing

```{r}
data <- read_excel("~/Desktop/data visualization/Net_generation_United_States_all_sectors_annual.xls")


data <- data |> separate("Year,petroleum liquids thousand megawatthours,coal thousand megawatthours,natural gas thousand megawatthours,nuclear thousand megawatthours,conventional hydroelectric thousand megawatthours,wind thousand megawatthours,all solar thousand megawatthours,geothermal thousand megawatthours",
                         into=c("year", "Petroleum", "Coal", "Natural Gas", "Nuclear", "Hydroelectric", "Wind", "Solar", "Geothermal"), sep=",")

data <- data[-c(22),]
data <- data[-c(1,2,3,4),]

data$Petroleum <- as.numeric(data$Petroleum)
data$Coal <- as.numeric(data$Coal)
data$"Natural Gas" <- as.numeric(data$"Natural Gas")
data$Nuclear <- as.numeric(data$Nuclear)
data$Hydroelectric <- as.numeric(data$Hydroelectric)
data$Wind <- as.numeric(data$Wind)
data$Solar <- as.numeric(data$Solar)
data$Geothermal <- as.numeric(data$Geothermal)

data[is.na(data)] <- 0 #to calculate the proportion, NA should be replaced by 0

year <- rep(2001:2017, by = 1) #creating year variable
year <- as.matrix(year)

x <- data |> select(-year)
x <- as.matrix(x)
x =  prop.table(x, margin = 1)
x <- cbind(x, year)

x <- as.data.frame(x) #change the matix to data.frame 
x <- relocate(x, "V9", .before = "Petroleum")
x <- x |>  rename(c(year = V9))
x$year <- sort(x$year, decreasing = TRUE)

k <- pivot_longer(x, !year, names_to = "energy", values_to = "percent")
k <- k |> mutate(percentage = percent * 100)


```

This is the code that I used for the replication of the original graph.
I'll explain challenges that I have been through with some codes below. 

## Replication

```{r}
color <- c("Coal" = "#67614c", "Geothermal" = "#e2e2e2", "Hydroelectric" = "#81e3e9",
           "Natural Gas" = "#e39424", "Nuclear" = "#9e71c2", "Petroleum" = "#d366a8",
           "Solar" = "#f7d930", "Wind" = "#719bc2")

ggplot(k, aes(x = year,
              node = energy,
              fill = energy,
              value = percentage)) +
  geom_sankey_bump(space = 0, type = "alluvial", color = "transparent", smooth = 13, alpha = 0.93) +
  theme_sankey_bump(base_size = 7)  +
  labs(x = NULL, y = NULL,
       title = "Sources of electricity generation in the United States") +
  scale_x_continuous(breaks = c(2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008,
                                2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017),
                     labels = c("2001", "02", "'03", "'04", "'05", "'06", "'07", "'08", "'09",
                                "'10", "'11", "'12", "'13", "'14", "'15", "'16", "2017")) +
  scale_y_continuous(labels = NULL) +
  theme_bw() + coord_cartesian(expand = FALSE) +
  theme(legend.position = c(0.8,-0.4),legend.title = element_blank(),
        legend.direction = "horizontal",
        legend.key.size = unit(c(0.4,0.4), "cm"),
        plot.title = element_text(size = 9, face = "bold"),
        legend.background = element_rect(color = "black"),
        legend.text = element_text(face = "bold", family = "Noto Sans KR", size = 7),
        plot.margin = unit(c(1,1,4,1), "cm"),
        legend.spacing.x = unit(0.2, 'cm')) +
  scale_fill_manual(values = color) +
  guides(fill = guide_legend(nrow = 4)) +
  annotate("text", x = 2003, y = 75, label = "Coal", size = 5, color = "#302d21", family = "Source Sans 3") +
  annotate("text", x = 2006.5, y = 40, label = "Natural gas", size = 4, color = "#302d21", family = "Source Sans 3") +
  annotate("text", x = 2007.5, y = 20, label = "Nuclear", size = 4, color = "#302d21", family = "Source Sans 3") +
  annotate("text", x = 2003, y = 7, label = "Hydroelectric", size = 3, color = "#302d21", family = "Source Sans 3") +
  annotate("text", x = 2015.3, y = 5.3, label = "WIND", size = 1.9, color = "#302d21", family = "Source Sans 3") +
  annotate("text", x = 2001.3, y = 70, label = "51%", size = 2, color = "#302d21", family = "Source Sans 3") +
  annotate("text", x = 2001.3, y = 40, label = "21%", size = 2, color = "#302d21", family = "Source Sans 3") +
  annotate("text", x = 2001.3, y = 19, label = "17%", size = 2, color = "#302d21", family = "Source Sans 3") +
  annotate("text", x = 2001.3, y = 6, label = "6%", size = 2, color = "#302d21", family = "Source Sans 3") +
  annotate("text", x = 2016.7, y = 85, label = "32%", size = 2, color = "#302d21", family = "Source Sans 3") +
  annotate("text", x = 2016.7, y = 52, label = "30%", size = 2, color = "#302d21", family = "Source Sans 3") +
  annotate("text", x = 2016.7, y = 28, label = "20%", size = 2, color = "#302d21", family = "Source Sans 3") +
  annotate("text", x = 2016.7, y = 13, label = "7%", size = 2, color = "#302d21", family = "Source Sans 3") +
  annotate("text", x = 2016.7, y = 6, label = "6%", size = 2, color = "#302d21", family = "Source Sans 3")
```

Code below is a fundamental structure of my graph replication. 
I put node, fill, and value to ggplot function and it constructs nodes for different sources of electricity generation and fills it by each color of sources. Moreover, as I put the percentage into the value, the magnitude of node is specified.

Then, geom_sankey_bump() is used to execute the basic ggplot code into geom_sankey graph format. With this function, I was able to smooth the graph and the type is specified as alluvial. 


```{r}
ggplot(k, aes(x = year,
              node = energy,
              fill = energy,
              value = percentage)) +
  geom_sankey_bump(space = 0, type = "alluvial", color = "transparent", smooth = 13, alpha = 0.93) +
  scale_fill_manual(values = color)
```

Because in the original graph, there is no background space except for the generated graph, I used theme_sankey_bump() function to adjust the base size of the graph.

```{r}
ggplot(k, aes(x = year,
              node = energy,
              fill = energy,
              value = percentage)) +
  geom_sankey_bump(space = 0, type = "alluvial", color = "transparent", smooth = 13, alpha = 0.93) +
  theme_sankey_bump(base_size = 7) +
  scale_fill_manual(values = color)
```

## Enhancement

```{r}

```


